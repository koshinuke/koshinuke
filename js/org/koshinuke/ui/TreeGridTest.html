<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<title>TreeGrid test</title>
		<script type="application/javascript" src="../../../../closure-library/closure/goog/base.js"></script>
		<script type="application/javascript" src="../../../../closure-library/third_party/closure/goog/base.js"></script>
		<script>
			// name resolving hack
			goog.require('goog.string.StringBuffer');
			goog.require('goog.soy');

		</script>
		<script type="application/javascript" src="../../../../js/soyutils_usegoog.js"></script>
		<script src="../deps.js"></script>
		<link rel="stylesheet/less" type="text/css" href="../../../../build/less/repos.less">
		<script type="application/javascript" src="../../../../js/less-1.1.5.min.js"></script>
		<script>
			goog.require('goog.array');
			goog.require('goog.dom');
			goog.require('goog.dom.query');
			goog.require('goog.testing.PropertyReplacer');
			goog.require('goog.testing.jsunit');
			goog.require('goog.testing.recordFunction');
			goog.require('org.koshinuke.ui.TreeGrid');
			goog.require('org.koshinuke.ui.TreeGrid.Node');

		</script>
	</head>
	<body>
		<table>
			<tr id="1">
				<td>a</td>
				<td>aa</td>
				<td>aaa</td>
			</tr>
			<tr id="2">
				<td>b</td>
				<td>bb</td>
				<td>bbb</td>
			</tr>
			<tr id="3">
				<td>c</td>
				<td>cc</td>
				<td>ccc</td>
			</tr>
		</table>
		<table id="tg" class="treegrid"></table>
		<script>
			function testSortModel() {
				var dc = function(l, r, i) {
					return goog.array.defaultCompare(l.ary[i], r.ary[i]);
				};
				var lc = function(l, r) {
					// prevent overflow
					if(l.level < r.level) {
						return -1;
					}
					if(r.level < l.level) {
						return 1;
					}
					return 0;
				}
				var comp = function(l, r) {
					var length = l.level;
					if(r.level < l.level) {
						length = r.level;
					}
					for(var i = 0; i < length; i++) {
						var diff = dc(l, r, i);
						if(diff) {
							return diff;
						}
					}
					if(l.type == r.type) {
						if(l.level == r.level) {
							var diff = dc(l, r, length);
							if(diff) {
								return diff;
							}
						}
						if(l.type == 'tree') {
							var diff = dc(l, r, length);
							if(diff) {
								return diff;
							}
							return lc(l, r);
						} else if(l.type == 'blob') {
							return lc(r, l);
						}
					} else if(l.type == 'tree') {
						if(l.level < r.level) {
							var diff = dc(l, r, length);
							if(diff) {
								return diff;
							}
						}
						return -1;
					} else if(l.type == 'blob') {
						if(r.level < l.level) {
							var diff = dc(l, r, length);
							if(diff) {
								return diff;
							}
						}
						return 1;
					}
					return 0;
				};
				var data = [{
					path : "aa/cc/zz",
					type : "blob"
				}, {
					path : "aaa/bbb",
					type : "tree"
				}, {
					path : "aa/cc",
					type : "tree"
				}, {
					path : "aaa",
					type : "tree"
				}, {
					path : "a",
					type : "blob"
				}, {
					path : "aa",
					type : "tree"
				}, {
					path : "aa",
					type : "blob"
				}, {
					path : "aa/bb",
					type : "blob"
				}];
				goog.array.forEach(data, function(a) {
					var ary = a.path.split('/');
					a.level = ary.length - 1;
					a.ary = ary;
				});
				var trace = function(l, r) {
					var result = comp(l, r);
					console.log(l.type, ':', l.path, '-', r.type, ':', r.path, '=', result);
					return result;
				}
				for(var x = 0; x < 5; x++) {
					goog.array.shuffle(data);
					console.log(data);
					goog.array.sort(data, trace);
					console.log(data);
					var expects = ['aa', 'aa/cc', 'aa/cc/zz', 'aa/bb', 'aaa', 'aaa/bbb', 'a'];
					goog.array.forEach(expects, function(a, i) {
						assertEquals(a, data[i].path);
					});
				}
			}

			function assertArraysEqual(arr1, arr2) {
				assertEquals('Expected length ' + arr1.length, arr1.length, arr2.length);
				for(var i = 0; i < arr1.length; i++) {
					assertEquals(arr1[i] + ' expected at position ' + i, arr1[i], arr2[i]);
				}
			}

			function testSortPath() {
				var data = ["aaa", "dddd", "bbb", "aaa/bbb", "bbb/ccc/dddd"];
				var expected = ["aaa", "aaa/bbb", "bbb", "bbb/ccc/dddd", "dddd"];
				goog.array.sort(data);
				assertArraysEqual(expected, data);
			}

			function testSibling() {
				var el = goog.dom.getNextElementSibling(goog.dom.getElement("1"));
				assertEquals("2", el.id);
			}
		</script>
	</body>
</html>